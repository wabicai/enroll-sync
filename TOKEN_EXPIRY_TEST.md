# JWT Token过期处理测试指南

## 🎯 测试目标

验证前端应用在JWT token过期时能够：
1. 自动检测token过期状态
2. 尝试使用refresh token自动刷新
3. 刷新失败时优雅地引导用户重新登录
4. 提供良好的用户体验，避免突然的认证失败

## 🔧 已实现的功能

### 1. 增强的API请求拦截器
- ✅ 自动检测401错误
- ✅ 自动尝试token刷新
- ✅ 避免并发刷新请求
- ✅ 刷新失败时清理状态并重定向

### 2. Token生命周期管理
- ✅ Token过期时间解析
- ✅ 提前5分钟自动刷新
- ✅ 定期检查token状态
- ✅ 页面可见性变化时检查

### 3. 状态管理优化
- ✅ 安全登录验证
- ✅ 认证状态检查
- ✅ 自动清理过期状态
- ✅ 跨标签页状态同步

### 4. 用户体验改进
- ✅ 路由保护增强
- ✅ 加载状态显示
- ✅ 错误处理优化
- ✅ 调试面板（开发环境）

## 🧪 测试步骤

### 测试1: 正常token刷新
1. 登录系统
2. 访问设置页面查看Token调试面板
3. 等待token接近过期时间（5分钟内）
4. 观察是否自动刷新token
5. 验证API请求继续正常工作

### 测试2: 模拟token过期
1. 登录系统
2. 访问设置页面的Token调试面板
3. 点击"模拟过期Token"按钮
4. 观察系统是否：
   - 检测到token过期
   - 尝试刷新token
   - 刷新失败后清理状态
   - 重定向到登录页面

### 测试3: API请求中的token过期
1. 登录系统
2. 使用浏览器开发者工具修改localStorage中的token为过期token
3. 尝试访问需要认证的页面（如审批中心）
4. 观察是否：
   - API请求返回401错误
   - 自动尝试刷新token
   - 刷新失败后重定向到登录页

### 测试4: 页面刷新后的状态检查
1. 登录系统
2. 手动修改localStorage中的token为过期token
3. 刷新页面
4. 观察是否：
   - 应用启动时检查token状态
   - 检测到过期token
   - 自动清理状态并重定向

## 🔍 调试工具

### Token调试面板
在开发环境下，访问设置页面可以看到Token调试面板，提供：
- Token状态显示（有效/过期/即将过期）
- Token详细信息（用户ID、过期时间、剩余时间）
- 手动刷新token按钮
- 模拟过期token按钮
- 登出按钮

### 浏览器控制台日志
系统会在控制台输出详细的认证相关日志：
- `🔐` Token获取和使用
- `🔄` Token刷新过程
- `✅` 操作成功
- `⚠️` 警告信息
- `❌` 错误信息

## 📝 测试检查清单

- [ ] 正常登录流程工作正常
- [ ] Token自动刷新机制工作
- [ ] API请求401错误自动处理
- [ ] 过期token检测和清理
- [ ] 用户友好的错误提示
- [ ] 页面刷新后状态保持
- [ ] 跨标签页状态同步
- [ ] 网络错误处理
- [ ] 调试面板功能正常

## 🚨 常见问题排查

### 问题1: Token刷新失败
**症状**: 控制台显示"Token刷新失败"
**排查**:
1. 检查后端refresh token接口是否正常
2. 验证refresh token是否有效
3. 检查网络连接

### 问题2: 无限重定向
**症状**: 页面不断重定向到登录页
**排查**:
1. 检查localStorage中的认证状态
2. 验证token格式是否正确
3. 检查认证检查逻辑

### 问题3: API请求失败
**症状**: 所有API请求都返回401错误
**排查**:
1. 检查token是否正确添加到请求头
2. 验证后端认证中间件
3. 检查token格式和签名

## 🔧 开发者注意事项

1. **Token刷新时机**: 系统会在token过期前5分钟自动刷新
2. **并发控制**: 避免同时发起多个刷新请求
3. **错误处理**: 所有认证错误都会触发状态清理
4. **用户体验**: 提供加载状态和友好的错误提示
5. **调试支持**: 开发环境提供详细的调试信息

## 📚 相关文件

- `src/lib/api.ts` - API请求拦截器
- `src/lib/auth.ts` - 认证工具函数
- `src/hooks/useAuth.ts` - 认证状态管理Hook
- `src/store/useAppStore.ts` - 全局状态管理
- `src/components/auth/RequireAuth.tsx` - 路由保护组件
- `src/components/auth/TokenDebugPanel.tsx` - 调试面板
